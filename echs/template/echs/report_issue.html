{% extends 'base.html' %}
{% load static %}

{% block extrahead %}
<style>
/* Container styling */
.report-issue-container {
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
    font-size: 0.8rem;
    font-weight: normal;
}

/* Form card */
.report-issue-container form {
    background-color: #f9f9f9;
    padding: 0.5rem;
    border-radius: 8px;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
}

/* Headings */
.report-issue-container h5,
.issue-table-container h5 {
    text-align: center;
    margin-bottom: 1.5rem;
}

/* Table font size */
.small-font-table {
    font-size: 0.7rem;
}

.small-font-table td,
.small-font-table th {
    white-space: normal;      /* Allow wrapping */
    word-wrap: break-word;    /* Break long words if needed */
    overflow-wrap: break-word;/* CSS3 standard */
    max-width: 65px;         /* Limit max width per cell, adjust as needed */
    vertical-align: top;      /* Align text to top */
}

/* Form field spacing */
.report-issue-container .mb-3 {
    margin-bottom: 1.5rem;
}

/* Disable textarea resize */
.report-issue-container textarea.form-control {
    padding-right: 1rem;
    resize: none;
}

/* Submit button */
.report-issue-container button[type="submit"] {
    width: 100%;
}
.report-issue-container ::placeholder {
    font-size: 0.75rem;
    color: #6c757d; /* Optional: standard Bootstrap muted text */
}
.report-issue-container input[type="file"] {
    font-size: 0.70rem;  /* Smaller font size for file input */
}

#submit-button {
    font-size: 0.75rem;  /* Smaller font size for submit button */
    padding: 0.4rem 0.75rem;  /* Optional: reduce vertical/horizontal padding */
}
.btn-view-issue {
    padding: 0.15rem 0.4rem;
    font-size: 0.65rem;
    line-height: 1;
    border-radius: 0.2rem;
}
#modal-description {
  word-break: break-word;   /* Break words if needed to wrap */
  white-space: normal;      /* Allow normal wrapping */
  overflow-wrap: anywhere;  /* Allow breaking words anywhere */
}

.modal-dialog {
  margin-top: 60px;
  max-width: 325px;
  width: 100%;
  max-height: 80vh; /* Reduce the modal height to 80% of the viewport */
  display: flex;
  flex-direction: column;
}

.modal-content {
  flex: 1 1 auto;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  max-height: 100%;
  border-radius: 0.5rem;
}

.modal-body {
  overflow-y: auto;
  flex-grow: 1;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  font-size: 0.70rem;
  line-height: 1.2;
  color: #333;
  max-height: calc(80vh - 120px); /* Subtract modal header/footer approx. height */
}

.modal-header {
  padding: 0.4rem 0.6rem;     /* Reduced top/bottom padding */
  min-height: 1.5rem; 
  font-size: 0.85rem;          /* Smaller overall header text */
  background-color: #cbcfd3;   /* Optional: light gray background */
  border-bottom: 2px solid #0e7be8;
}

.modal-header .btn-close {
  padding: 0.1rem;         /* Minimal padding */
  font-size: 0.75rem;      /* Smaller icon */
  line-height: 1;
  height: 0.5rem;            /* Optional: explicitly restrict height */
  width: 1rem;             /* Optional: restrict width */
  margin: 0;               /* Remove any default margin */
  align-self: center;      /* Vertically align with title */
}

.modal-title {
  font-size: 0.85rem;
  font-weight: 600;
  margin: 0;
  line-height: 1.2;
}

.modal-footer {
  padding: 0.3rem 0.75rem;
  display: none; /* Hides footer including the Close button */
}

.modal-header .btn-close {
  margin-top: 0; /* Optional: align close icon neatly */
  font-size: 0.9rem;
}


</style>
{% endblock %}

{% block content %}
<div class="container mt-1">

    <!-- Table Section -->
    <div class="issue-table-container mb-1">

    <h5 class="fw-bold" style="font-size: 0.8rem; text-align: left; margin-top: 1rem; margin-bottom: 0.25rem;">
        Report an Issues
    </h5>
    
        
    <!-- Form Section -->
    <div class="report-issue-container">
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} {% if 'no-dismiss' in message.tags %}no-auto-dismiss{% endif %}" style="font-size: 0.8rem;">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}


        {% if form %}
        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <div class="mb-3">
                {{ form.description.label_tag }}
                {{ form.description }}
                {% if form.description.errors %}
                <div class="text-danger">{{ form.description.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.attachment.label_tag }}
                {{ form.attachment }}
                {% if form.attachment.help_text %}
                <small class="form-text text-muted">{{ form.attachment.help_text }}</small>
                {% endif %}
                {% if form.attachment.errors %}
                <div class="text-danger">{{ form.attachment.errors }}</div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary" id="submit-button" disabled>Submit Issue</button>
        </form>
    {% endif %}
    </div>

    <h5 class="fw-bold" style="font-size: 0.7rem; text-align: left; margin-top: 1rem; margin-bottom: 0.25rem;">
        Your Reported Issues
    </h5>

        {% if user_issues %}
        <div class="table-responsive">
            <table class="table table-bordered table-sm table-striped small-font-table">
                <thead class="table-light text-center">
                    <tr>
                        <th>#</th>
                        <th>Issue No.-Date</th>
                        <th>Description</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for issue in user_issues %}
                    <tr>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td class="text-monospace">{{ issue.issue_id }}<br><br> {{ issue.created_at }} </td>
                        <td>
                            {% if issue.description|wordcount > 15 %}
                                {{ issue.description|truncatewords:15|truncatechars:100 }}...
                            {% else %}
                                {{ issue.description|truncatechars:100 }}
                            {% endif %}
                        </td>

                        <td>
                            {{ issue.get_current_status_display }}
                            <div class="text-center mt-1">
                                <button
                                    type="button"
                                    class="btn btn-info btn-view-issue"
                                    data-bs-toggle="modal"
                                    data-bs-target="#issueModal"
                                    data-issue_id="{{ issue.issue_id }}"
                                    data-created_at="{{ issue.created_at|date:'Y-m-d H:i' }}"
                                    data-description="{{ issue.description|escapejs }}"
                                    data-attachment_url="{% if issue.attachment %}{{ issue.attachment.url }}{% else %}{% endif %}"
                                    data-current_status="{{ issue.get_current_status_display }}"
                                    data-admin_remark="{{ issue.admin_remark|default:'None'|escapejs }}"
                                >
                                    View
                                </button>
                            </div>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Issue Details Modal -->
            <div class="modal fade" id="issueModal" tabindex="-1" aria-labelledby="issueModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="issueModalLabel">Issue Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <dl class="row">
                            <dt class="col-sm-3">Issue ID:</dt>
                            <dd class="col-sm-9" id="modal-issue-id"></dd>

                            <dt class="col-sm-3">Reported On:</dt>
                            <dd class="col-sm-9" id="modal-created-at"></dd>

                            <dt class="col-sm-3">Description:</dt>
                            <dd class="col-sm-9" id="modal-description"></dd>

                            <dt class="col-sm-3">Attachment:</dt>
                            <dd class="col-sm-9" id="modal-attachment">
                                <!-- Image preview or file link will go here -->
                            </dd>

                            <dt class="col-sm-3">Status:</dt>
                            <dd class="col-sm-9" id="modal-status"></dd>

                            <dt class="col-sm-3">Support Remark:</dt>
                            <dd class="col-sm-9" id="modal-admin-remark"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        {% else %}
        <p class="text-muted text-center">No issues reported yet.</p>
        {% endif %}
    </div>


</div>
{% endblock %}

{% block extrascripts %}
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {

    // Auto-dismiss alerts after 1.5s unless marked no-auto-dismiss
    document.querySelectorAll('.alert').forEach(alert => {
        if (!alert.classList.contains('no-auto-dismiss')) {
            setTimeout(() => {
                let bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bsAlert.close();
            }, 1500);
        }
    });

    // Spinner function (make sure #loading-overlay exists in base.html if using this)
    function showSpinner() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.style.display = 'flex';
    }

    // Attach spinner trigger to form submit
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function () {
            showSpinner();
        });
    });

    // Enable submit button only when textarea has content
    const textarea = document.getElementById("id_description");
    const submitBtn = document.getElementById("submit-button");

    function toggleSubmitButton() {
        submitBtn.disabled = textarea.value.trim().length === 0;
    }

    if (textarea) {
        textarea.addEventListener("input", toggleSubmitButton);
        toggleSubmitButton(); // Initial check
    }

    // Modal logic: populate modal with clicked issue details
    const modal = document.getElementById('issueModal');
    if (modal) {
        modal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget; // Button that triggered the modal

            // Get data attributes from the button
            const issueId = button.getAttribute('data-issue_id');
            const createdAt = button.getAttribute('data-created_at');
            const description = button.getAttribute('data-description');
            const attachmentUrl = button.getAttribute('data-attachment_url');
            const status = button.getAttribute('data-current_status');
            const adminRemark = button.getAttribute('data-admin_remark');

            // Fill modal content elements
            document.getElementById('modal-issue-id').textContent = issueId;
            document.getElementById('modal-created-at').textContent = createdAt;
            document.getElementById('modal-description').textContent = description;
            document.getElementById('modal-status').textContent = status;
            document.getElementById('modal-admin-remark').textContent = adminRemark || 'None';

            // Attachment preview
            const modalAttachment = document.getElementById('modal-attachment');
            if (attachmentUrl) {
                if (/\.(jpg|jpeg|png|gif)$/i.test(attachmentUrl)) {
                    // Show image preview
                    modalAttachment.innerHTML = `<img src="${attachmentUrl}" alt="Attachment Image" class="img-fluid rounded" style="max-height: 200px;">`;
                } else {
                    // Show download link for non-images
                    modalAttachment.innerHTML = `<a href="${attachmentUrl}" target="_blank">Download attachment</a>`;
                }
            } else {
                modalAttachment.textContent = 'None';
            }
        });
    }

});
</script>
{% endblock %}

