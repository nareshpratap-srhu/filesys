{% extends "base.html" %}
{% block content %}

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center">
        <p class="mt-1" style="font-size: 0.975rem;"><strong>
            Selected IP: {{ uhid|slice:":2" }}/{{ uhid|slice:"2:" }}</strong>
        </p>
    </div>

        <div class="row">
            <h6 class="text-customcolor">Patient Name : {{patient_name}}</h6>
        </div>

        {% if request.GET.restored %}
            <div id="restore-success-message" class="alert alert-success mt-3">
                File restored successfully!
            </div>
        {% endif %}

    <div class="row">
        {% for file in files %}
        <div class="col-12 mb-1">
            <div class="card w-100">
                <div class="card-body d-flex flex-column">
                    <p class="card-title text-break" style="font-size: 0.975rem;">{{ file.filename }}</p>
                    <p class="card-text mb-1" style="font-size: 0.775rem;">
                        
                        {% if file.custom_tag %}
                            <strong>Tag: {{ file.custom_tag }}</strong><br>
                        {% endif %}
                        File Type:  {{ file.file_type }}<br>
                        On: {{ file.formatted_datetime }}<br>
                        By: {{ file.user.full_name }}<br> 

                            {% if file.user.designation %}
                                {{ file.user.designation.title }}
                                {% if file.user.designation_other %}
                                    ({{ file.user.designation_other }})
                                {% endif %}
                                <br>
                            {% endif %}
                            
                            {% if file.user.department %}
                                {{ file.user.department.name }}
                                {% if file.user.department_other %}
                                    ({{ file.user.department_other }})
                                {% endif %}
                                <br>
                            {% endif %}

                        {{ file.file_size_kb }} KB ({{ file.file_size_mb }} MB)


                    </p>
                 
                    <div class="mt-auto text-end">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#previewModal{{ forloop.counter }}">Preview</button>
                        {% if file.deleted_by == request.user.id %}
                            <a href="{% url 'echs:restore_item' file.id file.source %}?uhid={{ uhid }}"class="btn btn-success btn-sm"> Restore</a>
                        {% endif %}

                    </div>
                </div>
            </div>

            <!-- Preview Modal -->
            <div class="modal fade" id="previewModal{{ forloop.counter }}"
                 tabindex="-1"
                 aria-labelledby="previewModalLabel{{ forloop.counter }}"
                 aria-hidden="true">

              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="max-width: 375px; margin: auto;">
                
                  <div class="modal-header py-2">
                    <h6 class="modal-title">Preview</h6>
                    <button type="button" class="btn-close btn-sm" data-bs-dismiss="modal"></button>
                  </div>
              
                  <div class="modal-body p-0">


                    {% if file.file_type == "Image" %}
                        <img src="{{ file.file_url }}" style="width:100%;">
                    {% endif %}

                    {% if file.file_type == "PDF" %}
                        <iframe src="{{ file.file_url }}" style="width:100%; height:500px;"></iframe>
                    {% endif %}
                    
                  </div>
              
                </div>
              </div>
            </div>
        {% empty %}
        <p>Your Recycle bin is Empty.</p>
        {% endfor %}
    </div>

    <!-- Back Button -->
    <div class="text-center mt-4">
        <a href="{% url 'echs:echs_uhid_options'%}?uhid={{ uhid }}" class="btn btn-secondary">Back</a>
    </div>
    
</div>

{% endblock %}

{% block extrascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const msg = document.getElementById('restore-success-message');
        if (msg) {
            setTimeout(() => msg.style.display = 'none', 4000);
        }
    });

    function confirmDelete(deleteUrl) {
        if (confirm("Are you sure you want to delete this item?")) {
            window.location.href = deleteUrl;
        }
    }
</script>
{% endblock %}
